name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Check file structure
      run: |
        echo "Checking required files..."
        test -f ClaudeMCP_Remote/__init__.py || (echo "Missing ClaudeMCP_Remote/__init__.py" && exit 1)
        test -f ClaudeMCP_Remote/liveapi_tools.py || (echo "Missing ClaudeMCP_Remote/liveapi_tools.py" && exit 1)
        test -d ClaudeMCP_Remote/tools || (echo "Missing ClaudeMCP_Remote/tools/ directory" && exit 1)
        test -f ClaudeMCP_Remote/tools/__init__.py || (echo "Missing ClaudeMCP_Remote/tools/__init__.py" && exit 1)
        test -f ClaudeMCP_Remote/tools/base.py || (echo "Missing ClaudeMCP_Remote/tools/base.py" && exit 1)
        test -f install.sh || (echo "Missing install.sh" && exit 1)
        test -f README.md || (echo "Missing README.md" && exit 1)
        test -f LICENSE || (echo "Missing LICENSE" && exit 1)
        echo "✓ All required files present"

    - name: Validate Python syntax
      run: |
        echo "Checking Python 3.7+ syntax validity..."
        python3 -m py_compile ClaudeMCP_Remote/liveapi_tools.py || (echo "Syntax error in liveapi_tools.py" && exit 1)
        for f in ClaudeMCP_Remote/tools/*.py; do
          python3 -m py_compile "$f" || (echo "Syntax error in $f" && exit 1)
        done
        echo "✓ All Python files compile successfully"

    - name: Check for common issues
      run: |
        echo "Checking for common issues..."
        # Check that socket port is consistent
        grep -q "9004" ClaudeMCP_Remote/__init__.py || (echo "Socket port 9004 not found in __init__.py" && exit 1)
        echo "✓ Configuration checks passed"

    - name: Validate documentation
      run: |
        echo "Checking documentation..."
        test -f docs/ARCHITECTURE.md || (echo "Missing docs/ARCHITECTURE.md" && exit 1)
        test -d examples || (echo "Missing examples directory" && exit 1)
        echo "✓ Documentation structure valid"

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install ruff
      run: pip install ruff

    - name: Check linting
      run: ruff check .

    - name: Check formatting
      run: ruff format --check .

  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dev dependencies
      run: pip install -r requirements-dev.txt

    - name: Run tests
      run: pytest

  shellcheck:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Run shellcheck on install.sh
      run: |
        sudo apt-get install -y shellcheck
        shellcheck install.sh || echo "Shellcheck warnings found (non-blocking)"
